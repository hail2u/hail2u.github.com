<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01//EN" "http://www.w3.org/TR/html4/strict.dtd">
<html>
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<title>JSON2XMLのサンプル</title>
<link rel="stylesheet" type="text/css" href="http://yui.yahooapis.com/2.7.0/build/fonts/fonts-min.css">
<script type="text/javascript" src="http://www.google.com/jsapi"></script>
<script type="text/javascript">
google.load("jquery", "1.3.2");
</script>
<script type="text/javascript">
$(function () {
  $("#json2xml").submit(function () {
    loadJSON($("#url").val());
    return false;
  });
});

function loadJSON(url) {
  $("#result").empty().append("<p/>").addClass("status").append(url + " をロードしています･･･");

  $.getJSON("http://pipes.yahoo.com/pipes/pipe.run?_callback=?", {
    _id:     "332d9216d8910ba39e6c2577fd321a6a",
    _render: "json",
    u:       url
  }, function (data) {
    var res = data.value.items;

    if (!data || !res || res === "") {
      $("#result").empty().append("<p/>").addClass("error").append(url + " がロードできませんでした。");
    } else {
      $("#result").empty().append("<p/>").addClass("status").append("XML に変換しています･･･");

      var xml = "<?xml version=\"1.0\" encoding=\"UTF-8\"?>\n<root>\n" + JSONtoXML(res, 0) + "</root>";
      $("#result").empty().append("<p/>").append($("<a/>").attr({
        href: "data:application/xml," + encodeURIComponent(xml)
      }).text("ブラウザで XML を開く"));
    }
  });
}

function JSONtoXML (obj, depth) {
  var result = "", indent = "";

  for (var i = 0; i < depth; i++) {
    indent += "  ";
  }

  for (var key in obj) {
    var name = key;
    if (key.match(/^\d+$/)) name = "item";

    if (typeof(obj[key]) == "object") {
      result += indent + "<" + name + ">\n";
      depth++;
      result += JSONtoXML(obj[key], depth);
      result += indent + "</" + name + ">\n";
      depth--;
    } else {
      result += indent + "<" + name + ">" + encodeEntities(obj[key]) + "</" + name + ">\n";
    }
  }

  return result;
}

function encodeEntities (s) {
  return s.replace(/&/g, "&amp;").replace(/</g, "&lt;").replace(/>/g, "&gt;").replace(/"/g, "&quot;"); //"
}
</script>
</head>
<body>
<h1>JSON2XMLのサンプル</h1>
<form action="./json2xml.html" id="json2xml">
  <p>
    <label for="url">URL:</label>
    <input type="text" size="60" value="http://feeds.delicious.com/v2/json/popular" id="url">
    <input type="submit" value="Convert">
  </p>
</form>
<div id="result"></div>
<hr>
<p>JSONをXMLに変換して、dataスキームでそのデータをhrefに指定したa要素を作り、それを開いてブラウザに表示させるというもの。改行やインデントがなかったりして読みづらいJSONを、Firefoxの折りたたみできるXML表示機能を使って読もうという感じ。Firefox 3で確認。他は知らない。</p>
<p>ローカルのJSONデータに対しては別に作る必要がありそう。</p>
<p>UTF-8以外の文字コードのことは忘れると良いと思います。</p>
<p>dataスキームのネタは<a href="http://piro.sakura.ne.jp/latest/blosxom.cgi/webtech/javascript/2005-10-05_download.htm">Latest topics &gt; JavaScriptでテキストファイルを生成してダウンロードさせる - outsider reflex</a>から。</p>
</body>
</html>
